{"version":3,"sources":["node_modules/jwt-decode/build/esm/index.js","src/app/_services/_core/auth.service.ts"],"sourcesContent":["export class InvalidTokenError extends Error {}\nInvalidTokenError.prototype.name = \"InvalidTokenError\";\nfunction b64DecodeUnicode(str) {\n  return decodeURIComponent(atob(str).replace(/(.)/g, (m, p) => {\n    let code = p.charCodeAt(0).toString(16).toUpperCase();\n    if (code.length < 2) {\n      code = \"0\" + code;\n    }\n    return \"%\" + code;\n  }));\n}\nfunction base64UrlDecode(str) {\n  let output = str.replace(/-/g, \"+\").replace(/_/g, \"/\");\n  switch (output.length % 4) {\n    case 0:\n      break;\n    case 2:\n      output += \"==\";\n      break;\n    case 3:\n      output += \"=\";\n      break;\n    default:\n      throw new Error(\"base64 string is not of the correct length\");\n  }\n  try {\n    return b64DecodeUnicode(output);\n  } catch (err) {\n    return atob(output);\n  }\n}\nexport function jwtDecode(token, options) {\n  if (typeof token !== \"string\") {\n    throw new InvalidTokenError(\"Invalid token specified: must be a string\");\n  }\n  options || (options = {});\n  const pos = options.header === true ? 0 : 1;\n  const part = token.split(\".\")[pos];\n  if (typeof part !== \"string\") {\n    throw new InvalidTokenError(`Invalid token specified: missing part #${pos + 1}`);\n  }\n  let decoded;\n  try {\n    decoded = base64UrlDecode(part);\n  } catch (e) {\n    throw new InvalidTokenError(`Invalid token specified: invalid base64 for part #${pos + 1} (${e.message})`);\n  }\n  try {\n    return JSON.parse(decoded);\n  } catch (e) {\n    throw new InvalidTokenError(`Invalid token specified: invalid json for part #${pos + 1} (${e.message})`);\n  }\n}","import { HttpClient } from '@angular/common/http';\r\nimport { computed, inject, Injectable, signal, WritableSignal } from '@angular/core';\r\nimport { Router } from '@angular/router';\r\nimport { jwtDecode } from 'jwt-decode';\r\nimport { catchError, Observable, tap, throwError } from 'rxjs';\r\nimport { environment } from '../../../environments/environment.development';\r\nimport { AuthResponse, LoginSaveData, RegisterSaveData } from '../../_types/auth/auth.model';\r\nimport { User } from '../../_types/auth/user.type';\r\n\r\n@Injectable({\r\n  providedIn: 'root',\r\n})\r\nexport class AuthService {\r\n  private _httpClient = inject(HttpClient);\r\n  private _router = inject(Router);\r\n\r\n  private _currentUser: WritableSignal<User | null> = signal<User | null>(null);\r\n  currentUser = this._currentUser.asReadonly();\r\n  isLoggedIn = computed(() => !!this._currentUser());\r\n\r\n  private tokenExpirationTimer: any;\r\n\r\n  constructor() {\r\n    this.tryAutoLogin();\r\n  }\r\n\r\n  login(data: LoginSaveData): Observable<AuthResponse> {\r\n    return this._httpClient.post<AuthResponse>(`${environment.apiUrl}/auth/login/`, data).pipe(\r\n      tap((res) => this.handleAuthentication(res)),\r\n      catchError((err) => throwError(() => err)),\r\n    );\r\n  }\r\n\r\n  register(data: RegisterSaveData): Observable<AuthResponse> {\r\n    return this._httpClient.post<AuthResponse>(`${environment.apiUrl}/auth/register/`, data).pipe(\r\n      tap((res) => this.handleAuthentication(res)),\r\n      catchError((err) => throwError(() => err)),\r\n    );\r\n  }\r\n\r\n  refreshToken(token: string): Observable<AuthResponse> {\r\n    return this._httpClient\r\n      .post<AuthResponse>(`${environment.apiUrl}/auth/refresh/`, { refresh: token })\r\n      .pipe(\r\n        tap((res) => this.handleAuthentication(res)),\r\n        catchError((err) => throwError(() => err)),\r\n      );\r\n  }\r\n\r\n  logout() {\r\n    this._currentUser.set(null);\r\n    localStorage.removeItem('auth_data');\r\n    if (this.tokenExpirationTimer) {\r\n      clearTimeout(this.tokenExpirationTimer);\r\n    }\r\n    this._router.navigate(['/auth']);\r\n  }\r\n\r\n  private handleAuthentication(res: AuthResponse) {\r\n    this._currentUser.set(res.user);\r\n    localStorage.setItem('auth_data', JSON.stringify(res));\r\n\r\n    const decodedToken: any = jwtDecode(res.access);\r\n    const expirationDate = new Date(decodedToken.exp * 1000);\r\n    this.autoLogout(expirationDate.getTime() - new Date().getTime());\r\n  }\r\n\r\n  private tryAutoLogin() {\r\n    const storedData = localStorage.getItem('auth_data');\r\n\r\n    if (!storedData) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const authData: AuthResponse = JSON.parse(storedData);\r\n      if (!authData.access || !authData.user) {\r\n        return;\r\n      }\r\n\r\n      const decodedToken: any = jwtDecode(authData.access);\r\n      const expirationDate = new Date(decodedToken.exp * 1000);\r\n      const now = new Date();\r\n\r\n      if (expirationDate > now) {\r\n        this._currentUser.set(authData.user);\r\n        this.autoLogout(expirationDate.getTime() - now.getTime());\r\n      } else {\r\n        this.logout();\r\n      }\r\n    } catch (e) {\r\n      this.logout();\r\n    }\r\n  }\r\n\r\n  private autoLogout(expirationDuration: number) {\r\n    if (this.tokenExpirationTimer) {\r\n      clearTimeout(this.tokenExpirationTimer);\r\n    }\r\n    this.tokenExpirationTimer = setTimeout(() => {\r\n      this.logout();\r\n    }, expirationDuration);\r\n  }\r\n\r\n  private getAuthDataFromLocalStorage(): AuthResponse | null {\r\n    const data = localStorage.getItem('auth_data');\r\n    return data ? JSON.parse(data) : null;\r\n  }\r\n\r\n  getToken(): string | null {\r\n    return this.getAuthDataFromLocalStorage()?.access || null;\r\n  }\r\n\r\n  getRefreshToken(): string | null {\r\n    return this.getAuthDataFromLocalStorage()?.refresh || null;\r\n  }\r\n}\r\n"],"mappings":"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","names":["InvalidTokenError","b64DecodeUnicode","str","m","p","code","base64UrlDecode","output","jwtDecode","token","options","pos","part","decoded","e","AuthService","_httpClient","inject","HttpClient","_router","Router","_currentUser","signal","currentUser","asReadonly","isLoggedIn","computed","tokenExpirationTimer","constructor","tryAutoLogin","login","data","post","environment","apiUrl","pipe","tap","res","handleAuthentication","catchError","err","throwError","register","refreshToken","token","refresh","logout","set","localStorage","removeItem","clearTimeout","navigate","user","setItem","JSON","stringify","decodedToken","jwtDecode","access","expirationDate","Date","exp","autoLogout","getTime","storedData","getItem","authData","parse","now","expirationDuration","setTimeout","getAuthDataFromLocalStorage","getToken","getRefreshToken","factory","Éµfac","providedIn"],"x_google_ignoreList":[0]}