import{b as k,f as h}from"./chunk-AJ7YYZRY.js";import{O as u,Sb as f,T as d,Y as l,jc as w,k as s,na as m,z as c}from"./chunk-P2MU52AP.js";var n=class extends Error{};n.prototype.name="InvalidTokenError";function T(r){return decodeURIComponent(atob(r).replace(/(.)/g,(o,e)=>{let t=e.charCodeAt(0).toString(16).toUpperCase();return t.length<2&&(t="0"+t),"%"+t}))}function D(r){let o=r.replace(/-/g,"+").replace(/_/g,"/");switch(o.length%4){case 0:break;case 2:o+="==";break;case 3:o+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return T(o)}catch{return atob(o)}}function p(r,o){if(typeof r!="string")throw new n("Invalid token specified: must be a string");o||(o={});let e=o.header===!0?0:1,t=r.split(".")[e];if(typeof t!="string")throw new n(`Invalid token specified: missing part #${e+1}`);let i;try{i=D(t)}catch(a){throw new n(`Invalid token specified: invalid base64 for part #${e+1} (${a.message})`)}try{return JSON.parse(i)}catch(a){throw new n(`Invalid token specified: invalid json for part #${e+1} (${a.message})`)}}var E=(()=>{class r{_httpClient=l(w);_router=l(k);_currentUser=m(null);currentUser=this._currentUser.asReadonly();isLoggedIn=f(()=>!!this._currentUser());tokenExpirationTimer;constructor(){this.tryAutoLogin()}login(e){return this._httpClient.post(`${h.apiUrl}/auth/login/`,e).pipe(u(t=>this.handleAuthentication(t)),c(t=>s(()=>t)))}register(e){return this._httpClient.post(`${h.apiUrl}/auth/register/`,e).pipe(u(t=>this.handleAuthentication(t)),c(t=>s(()=>t)))}refreshToken(e){return this._httpClient.post(`${h.apiUrl}/auth/refresh/`,{refresh:e}).pipe(u(t=>this.handleAuthentication(t)),c(t=>s(()=>t)))}logout(){this._currentUser.set(null),localStorage.removeItem("auth_data"),this.tokenExpirationTimer&&clearTimeout(this.tokenExpirationTimer),this._router.navigate(["/auth"])}handleAuthentication(e){this._currentUser.set(e.user),localStorage.setItem("auth_data",JSON.stringify(e));let t=p(e.access),i=new Date(t.exp*1e3);this.autoLogout(i.getTime()-new Date().getTime())}tryAutoLogin(){let e=localStorage.getItem("auth_data");if(e)try{let t=JSON.parse(e);if(!t.access||!t.user)return;let i=p(t.access),a=new Date(i.exp*1e3),g=new Date;a>g?(this._currentUser.set(t.user),this.autoLogout(a.getTime()-g.getTime())):this.logout()}catch{this.logout()}}autoLogout(e){this.tokenExpirationTimer&&clearTimeout(this.tokenExpirationTimer),this.tokenExpirationTimer=setTimeout(()=>{this.logout()},e)}getAuthDataFromLocalStorage(){let e=localStorage.getItem("auth_data");return e?JSON.parse(e):null}getToken(){return this.getAuthDataFromLocalStorage()?.access||null}getRefreshToken(){return this.getAuthDataFromLocalStorage()?.refresh||null}static \u0275fac=function(t){return new(t||r)};static \u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})}return r})();export{E as a};
//# sourceMappingURL=chunk-WMGIU37V.js.map
