import{b as v,f as l}from"./chunk-S5AG3UBK.js";import{O as c,Sb as m,T as g,Y as p,jc as f,k as s,na as d,z as u}from"./chunk-UQET437M.js";var a=class extends Error{};a.prototype.name="InvalidTokenError";function D(r){return decodeURIComponent(atob(r).replace(/(.)/g,(e,t)=>{let o=t.charCodeAt(0).toString(16).toUpperCase();return o.length<2&&(o="0"+o),"%"+o}))}function w(r){let e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return D(e)}catch{return atob(e)}}function h(r,e){if(typeof r!="string")throw new a("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,o=r.split(".")[t];if(typeof o!="string")throw new a(`Invalid token specified: missing part #${t+1}`);let i;try{i=w(o)}catch(n){throw new a(`Invalid token specified: invalid base64 for part #${t+1} (${n.message})`)}try{return JSON.parse(i)}catch(n){throw new a(`Invalid token specified: invalid json for part #${t+1} (${n.message})`)}}var b=class r{_httpClient=p(f);_router=p(v);_currentUser=d(null);currentUser=this._currentUser.asReadonly();isLoggedIn=m(()=>!!this._currentUser());tokenExpirationTimer;constructor(){this.tryAutoLogin()}login(e){return this._httpClient.post(`${l.apiUrl}/auth/login/`,e).pipe(c(t=>this.handleAuthentication(t)),u(t=>s(()=>t)))}register(e){return this._httpClient.post(`${l.apiUrl}/auth/register/`,e).pipe(c(t=>this.handleAuthentication(t)),u(t=>s(()=>t)))}refreshToken(e){return this._httpClient.post(`${l.apiUrl}/auth/refresh/`,{refresh:e}).pipe(c(t=>this.handleAuthentication(t)),u(t=>s(()=>t)))}logout(){this._currentUser.set(null),localStorage.removeItem("auth_data"),this.tokenExpirationTimer&&clearTimeout(this.tokenExpirationTimer),this._router.navigate(["/auth"])}handleAuthentication(e){this._currentUser.set(e.user),localStorage.setItem("auth_data",JSON.stringify(e));let t=h(e.access),o=new Date(t.exp*1e3);this.autoLogout(o.getTime()-new Date().getTime())}tryAutoLogin(){let e=localStorage.getItem("auth_data");if(e)try{let t=JSON.parse(e);if(!t.access||!t.user)return;let o=h(t.access),i=new Date(o.exp*1e3),n=new Date;i>n?(this._currentUser.set(t.user),this.autoLogout(i.getTime()-n.getTime())):this.logout()}catch{this.logout()}}autoLogout(e){this.tokenExpirationTimer&&clearTimeout(this.tokenExpirationTimer),this.tokenExpirationTimer=setTimeout(()=>{this.logout()},e)}getAuthDataFromLocalStorage(){let e=localStorage.getItem("auth_data");return e?JSON.parse(e):null}getToken(){return this.getAuthDataFromLocalStorage()?.access||null}getRefreshToken(){return this.getAuthDataFromLocalStorage()?.refresh||null}static \u0275fac=function(t){return new(t||r)};static \u0275prov=g({token:r,factory:r.\u0275fac,providedIn:"root"})};export{b as a};
